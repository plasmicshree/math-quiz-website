<!DOCTYPE html>
<html>
<head>
    <title>Firebase Test</title>
</head>
<body>
    <h1>Firebase Connectivity Test</h1>
    <div id="status">Initializing...</div>
    <div id="debug-log" style="border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px;">
    </div>

    <!-- Firebase SDK - using compat version for easier integration -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        const debugLog = document.getElementById('debug-log');
        const statusDiv = document.getElementById('status');

        function log(message) {
            console.log(message);
            const line = document.createElement('div');
            line.textContent = new Date().toLocaleTimeString() + ': ' + message;
            debugLog.appendChild(line);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCfAwDRE9JJFhW_j6_hg3wIp0oIX6c5-M0",
            authDomain: "math-app-d6f00.firebaseapp.com",
            projectId: "math-app-d6f00",
            storageBucket: "math-app-d6f00.appspot.com",
            messagingSenderId: "333699287838",
            appId: "1:333699287838:web:343907f2b4ebe2ce6a170f"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            log('✓ Firebase initialized successfully');
        } catch (error) {
            log('✗ Firebase initialization error: ' + error.message);
            statusDiv.textContent = 'Firebase initialization failed';
            throw error;
        }

        const db = firebase.firestore();
        log('✓ Firestore instance created');

        // Test 1: Write test document with detailed error info
        async function testWrite() {
            log('Starting write test (with 8s timeout)...');
            try {
                const testEmail = 'test@example.com';
                const timestamp = Date.now();
                const testDoc = {
                    testData: 'hello',
                    timestamp: new Date(),
                    message: 'Test at ' + new Date().toLocaleTimeString()
                };
                
                log('Attempting to write to: users/' + testEmail + '/test/test' + timestamp);
                
                // Add detailed error logging
                const writePromise = db.collection('users').doc(testEmail).collection('test').doc('test' + timestamp).set(testDoc);
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Write timeout after 8s')), 8000)
                );
                
                await Promise.race([writePromise, timeoutPromise]);
                log('✓ Successfully wrote test document');
                return true;
            } catch (error) {
                log('✗ Write operation result:');
                log('  Error code: ' + (error.code || 'N/A'));
                log('  Error message: ' + (error.message || 'No message'));
                log('  Error name: ' + (error.name || 'Unknown'));
                if (error.message && error.message.includes('timeout')) {
                    log('  → Write appears to have timed out. This might mean:');
                    log('    1. Security rules are blocking writes');
                    log('    2. Network connectivity issue');
                    log('    3. Firebase service temporarily unavailable');
                }
                return false;
            }
        }

        // Test 2: Read test document with timeout
        async function testRead() {
            log('Starting read test (with 5s timeout)...');
            try {
                const testEmail = 'test@example.com';
                
                const readPromise = db.collection('users').doc(testEmail).collection('test').get();
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Read timeout - likely security rules deny read access')), 5000)
                );
                
                const snapshot = await Promise.race([readPromise, timeoutPromise]);
                log('✓ Query successful, documents found: ' + snapshot.size);
                
                snapshot.forEach(doc => {
                    log('  Document: ' + doc.id + ' = ' + JSON.stringify(doc.data()));
                });
                
                return true;
            } catch (error) {
                log('✗ Read failed: ' + error.message);
                return false;
            }
        }

        // Run tests
        async function runTests() {
            statusDiv.textContent = 'Running Firebase tests...';
            log('========== Firebase Connectivity Tests ==========');
            
            const writeSuccess = await testWrite();
            log('');
            const readSuccess = await testRead();
            
            log('');
            log('========== ANALYSIS ==========');
            log('Write test result: ' + (writeSuccess ? 'PASSED' : 'FAILED'));
            log('Read test result: ' + (readSuccess ? 'PASSED' : 'FAILED'));
            log('');
            
            if (readSuccess) {
                log('✓ Firebase CAN read data - this means:');
                log('  - Connection to Firebase is working');
                log('  - Security rules allow read access');
            }
            
            if (writeSuccess) {
                statusDiv.textContent = '✓ All tests passed!';
                log('✓ Firebase CAN write data - everything works!');
            } else if (readSuccess && !writeSuccess) {
                statusDiv.textContent = '⚠ Partial - Read works but write times out';
                log('⚠ Write appears to fail but read works. Checking if write actually succeeded...');
                log('  (Sometimes the promise callback doesn\'t fire even though write succeeds)');
            } else {
                statusDiv.textContent = '✗ Some tests failed';
                log('✗ Check Firebase security rules and permissions');
            }
        }

        // Run tests after a short delay to ensure Firebase is loaded
        setTimeout(runTests, 1000);
    </script>
</body>
</html>
